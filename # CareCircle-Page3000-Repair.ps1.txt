# CareCircle-Page3000-Repair.ps1
# Purpose: Start CareCircle on http://localhost:3000 from the correct folder,
# freeing ports and clearing Next.js caches first.

param(
  [string[]]$CandidateRoots = @(
    "C:\Users\doitr\OneDrive\Desktop\radiant-ts",
    "C:\Users\doitr\Desktop\radiant-ts"
  )
)

Write-Host "=== CareCircle :3000 Repair ===" -ForegroundColor Cyan

# 1) Locate the project folder (prefers OneDrive path if present)
$AppRoot = $null
foreach ($p in $CandidateRoots) {
  if (Test-Path $p) { $AppRoot = $p; break }
}
if (-not $AppRoot) {
  Write-Error "Project folder not found. Checked: $($CandidateRoots -join ', ')"
  exit 1
}
Write-Host "Using project at: $AppRoot" -ForegroundColor Green
Set-Location $AppRoot

# 2) Free ports 3000 (Next) & 4001 (backend)
$ports = @(3000,4001)
foreach ($p in $ports) {
  $pids = (Get-NetTCPConnection -State Listen -LocalPort $p -ErrorAction SilentlyContinue |
           Select-Object -ExpandProperty OwningProcess -Unique)
  foreach ($pid in $pids) {
    try { Stop-Process -Id $pid -Force -ErrorAction Stop; Write-Host "Killed PID $pid on port $p" -ForegroundColor DarkGray } catch {}
  }
}

# 3) Clear Next.js caches (safe; forces a clean rebuild)
if (Test-Path ".next")  { Remove-Item ".next"  -Recurse -Force }
if (Test-Path ".turbo") { Remove-Item ".turbo" -Recurse -Force }

# 4) Quick env presence check (informational)
$hasEnv      = Test-Path ".env"
$hasEnvLocal = Test-Path ".env.local"
Write-Host ("Found .env:       " + ($hasEnv ? "yes" : "no")) -ForegroundColor DarkGray
Write-Host ("Found .env.local: " + ($hasEnvLocal ? "yes" : "no")) -ForegroundColor DarkGray

# 5) Start backend on :4001 in a new window if present
if (Test-Path ".\backend\server.ts") {
  Write-Host "Launching backend on :4001..." -ForegroundColor Green
  Start-Process powershell -ArgumentList "cd `"$AppRoot`"; npx tsx backend/server.ts" -WindowStyle Normal
} else {
  Write-Host "No backend/server.ts found; skipping backend launch." -ForegroundColor Yellow
}

# 6) Start Next.js on :3000 **in THIS WINDOW** so you can see logs
Write-Host "Launching Next.js on :3000 (watch this window for compile/errors)..." -ForegroundColor Green
Write-Host "Opening browser at http://localhost:3000 in 3 seconds..." -ForegroundColor DarkGray
Start-Sleep -Seconds 3
Start-Process "http://localhost:3000"

# Run dev server pinned to :3000
npx next dev -p 3000
